@using GenderPayGap.Core
@using GenderPayGap.WebUI.Models.Admin
@using GovUkDesignSystem
@using GovUkDesignSystem.GovUkDesignSystemComponents
@using Microsoft.AspNetCore.Html
@model GenderPayGap.WebUI.Models.Admin.AdminSearchViewModel

@{
    ViewBag.Title = "Search - Administration - Gender pay gap service";
    Layout = "~/Views/GovUkFrontend/GovUkFrontendLayout.cshtml";
}

@{

    object HighlightMatches(AdminSearchMatchViewModel searchMatch)
    {
        IHtmlContent startComment = Html.Raw("<!--");
        IHtmlContent endComment = Html.Raw("-->");

        Func<object, object> html =
            @<text>
                <span class="admin-search-highlighted">
                    @( startComment)
                    @{
                        string name = searchMatch.Text;
                        List<AdminSearchMatchGroupViewModel> matchGroups = searchMatch.MatchGroups;

                        var previousMatchEnd = 0;
                        foreach (AdminSearchMatchGroupViewModel matchGroup in matchGroups)
                        {
                            string nonBoldText = name.Substring(previousMatchEnd, matchGroup.Start - previousMatchEnd);
                            string boldText = name.Substring(matchGroup.Start, matchGroup.Length);

                            // The HTML / C# below looks a bit odd and oddly-formatted
                            // This is deliberate
                            // We do this because we want to avoid spaces between the text
                            @( endComment)@( nonBoldText)<b>@( boldText)</b>
                            @( startComment)

                            previousMatchEnd = matchGroup.Start + matchGroup.Length;
                        }

                        string finalNonBoldText = name.Substring(previousMatchEnd, name.Length - previousMatchEnd);
                    }
                    @( endComment)@( finalNonBoldText)
                </span>
             </text>;

        return html(new object());
    }

}

@section BeforeMain {
    @{
        var crumbs = new List<CrumbViewModel>
        {
            new CrumbViewModel
            {
                Text = "Admin",
                Href = Url.Action("Home", "Admin")
            },
            new CrumbViewModel
            {
                Text = "Search results"
            }
        };
    }

    @(Html.GovUkBreadcrumbs(new BreadcrumbsViewModel
    {
        Crumbs = crumbs
    }))
}

<div class="govuk-grid-row admin-search-page">
    <div class="govuk-grid-column-full">
        <span class="govuk-caption-xl">Administration</span>
        <form method="GET" action="@(Url.Action("SearchGet", "AdminSearch"))">
            <div class="govuk-form-group @(Model.Error != null ? "govuk-form-group--error" : "")">
                <label class="govuk-label" for="search-query">
                    <h1 class="govuk-heading-xl govuk-!-margin-bottom-0">Search for organisations and users</h1>
                </label>
                <div id="search-query-hint" class="govuk-hint govuk-!-margin-top-0">
                    <ul class="govuk-list govuk-!-margin-bottom-0">
                        <li class="govuk-hint">
                            <span class="govuk-!-font-weight-bold">Organisations:</span> search by current name, previous name, employer reference or company number
                        </li>
                        <li class="govuk-hint">
                            <span class="govuk-!-font-weight-bold">Users:</span> search by name or email address
                        </li>
                    </ul>
                </div>
                @if (Model.Error != null)
                {
                    <span class="govuk-error-message">
                        <span class="govuk-visually-hidden">Error:</span> @(Model.Error)
                    </span>
                }
                <div class="admin-search-box">
                    <input type="text"
                           name="query"
                           id="search-query"
                           class="govuk-input @(Model.Error != null ? "govuk-input--error" : "") admin-search-input"
                           value="@(Model.SearchQuery)"
                           aria-describedby="search-query-hint">
                    <button type="submit" class="admin-search-button">
                        <svg class="svg" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="3 4 26 26">
                            <path d="M25.7 24.8L21.9 21c.7-1 1.1-2.2 1.1-3.5 0-3.6-2.9-6.5-6.5-6.5S10 13.9 10 17.5s2.9 6.5 6.5 6.5c1.6 0 3-.6 4.1-1.5l3.7 3.7 1.4-1.4zM12 17.5c0-2.5 2-4.5 4.5-4.5s4.5 2 4.5 4.5-2 4.5-4.5 4.5-4.5-2-4.5-4.5z"/>
                        </svg>
                        Search
                    </button>
                </div>
            </div>
        </form>

        @if (Model.SearchResults != null)
        {
            <!--
            Loading      @(Model.SearchResults.LoadingMilliSeconds)ms
            Filtering    @(Model.SearchResults.FilteringMilliSeconds)ms
            Ordering     @(Model.SearchResults.OrderingMilliSeconds)ms
            Highlighting @(Model.SearchResults.HighlightingMilliSeconds)ms
            -->
            @if (Model.SearchResults.UsedCache)
            {
                <p class="govuk-body-s">
                    Changes made within the last @(Model.SearchResults.SearchCacheUpdatedSecondsAgo) seconds will not be reflected in these results.
                </p>
            }

            <details class="govuk-details" data-module="govuk-details" open>
                <summary class="govuk-details__summary">
                    <span class="govuk-details__summary-text">
                        <span class="govuk-!-font-weight-bold govuk-!-font-size-48">
                            @(Model.SearchResults.OrganisationResults.Count)
                        </span>
                        organisations containing
                        <span class="govuk-!-font-weight-bold">
                            @(Model.SearchQuery)
                        </span>
                    </span>
                </summary>
                <div class="govuk-details__text">
                    <table class="govuk-table">
                        <tbody class="govuk-table__body">
                            @foreach (AdminSearchResultOrganisationViewModel organisation in Model.SearchResults.OrganisationResults)
                            {
                                <tr class="govuk-table__row">
                                    <td class="govuk-table__cell">
                                        <a href="@(Url.Action("ViewOrganisation", "AdminViewOrganisation", new {id = organisation.OrganisationId}))"
                                           class="govuk-link">
                                            @(HighlightMatches(organisation.OrganisationName))
                                        </a>

                                        @foreach (AdminSearchMatchViewModel previousName in organisation.OrganisationPreviousNames)
                                        {
                                            <br/>
                                            @:previously @(HighlightMatches(previousName))
                                        }

                                        @if (organisation.EmployerRef != null)
                                        {
                                            <br/>
                                            @:Employer ref: <b>@(organisation.EmployerRef)</b>
                                        }
                                        @if (organisation.CompanyNumber != null)
                                        {
                                            <br/>
                                            @:Company number: <b>@(organisation.CompanyNumber)</b>
                                        }
                                        @if (organisation.Status != OrganisationStatuses.Active)
                                        {
                                            <br/>
                                            <span class="govuk-!-font-weight-bold">(@(organisation.Status))</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </details>

            <details class="govuk-details" data-module="govuk-details" open>
                <summary class="govuk-details__summary">
                    <span class="govuk-details__summary-text">
                        <span class="govuk-!-font-weight-bold govuk-!-font-size-48">
                            @(Model.SearchResults.UserResults.Count)
                        </span>
                        users containing
                        <span class="govuk-!-font-weight-bold">
                            @(Model.SearchQuery)
                        </span>
                    </span>
                </summary>
                <div class="govuk-details__text">
                    <table class="govuk-table">
                        <tbody class="govuk-table__body">
                            @foreach (AdminSearchResultUserViewModel user in Model.SearchResults.UserResults)
                            {
                                <tr class="govuk-table__row">
                                    <td class="govuk-table__cell">
                                        <a href="@Url.Action("ViewUser", "AdminViewUser", new {id = user.UserId})"
                                           class="govuk-link">
                                            @(HighlightMatches(user.UserFullName))
                                        </a>
                                        <br/>
                                        @(HighlightMatches(user.UserEmailAddress))

                                        @if (user.Status != UserStatuses.Active)
                                        {
                                            <br/>
                                            <span class="govuk-!-font-weight-bold">(@(user.Status))</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </details>
        }

    </div>
</div>
