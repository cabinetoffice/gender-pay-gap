@using GenderPayGap.Database
@using GovUkDesignSystem
@using GovUkDesignSystem.GovUkDesignSystemComponents
@model GenderPayGap.WebUI.Models.Admin.AdminOrganisationReturnDetailsViewModel

@{
    ViewBag.Title = $"Return details - {Model.Organisation.OrganisationName} - Administration - Gender pay gap service";
    Layout = "~/Views/GovUkFrontend/GovUkFrontendLayout.cshtml";
}

@section BeforeMain {
    @{
        var crumbs = new List<CrumbViewModel>();
        crumbs.Add(new CrumbViewModel
        {
            Text = "Admin",
            Href = Url.Action("Home", "Admin")
        });

        crumbs.Add(new CrumbViewModel
        {
            Text = Model.Organisation.OrganisationName,
            Href = Url.Action("ViewOrganisation", "AdminViewOrganisation", new { id = Model.Organisation.OrganisationId })
        });

        crumbs.Add(new CrumbViewModel
        {
            Text = "Returns",
            Href = Url.Action("ViewReturns", "AdminOrganisationReturn", new { id = Model.Organisation.OrganisationId })
        });

        crumbs.Add(new CrumbViewModel
        {
            Text = "Return details"
        });
    }

    @(Html.GovUkBreadcrumbs(new BreadcrumbsViewModel
    {
        Crumbs = crumbs
    }))
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        <span class="govuk-caption-xl">Administration</span>
        <h1 class="govuk-heading-xl">
            Return details
            <br />
            <span class="govuk-!-font-size-27" style="display: inline-block; margin-top: 15px;">
                for @(Model.Organisation.OrganisationName)
                <br />
                for reporting year @(Model.Year)-@((Model.Year + 1) % 100)
            </span>
        </h1>

        <p class="govuk-body govuk-!-margin-bottom-6">
            <a href="@Url.Action("DownloadReturnDetailsCsv", "AdminOrganisationReturn", new { id = Model.Organisation.OrganisationId })"
               class="govuk-link">
                Download CSV of return details <span class="govuk-visually-hidden">for @(Model.Organisation.OrganisationName)</span>
            </a>
        </p>

        <table class="govuk-table">
            <tbody class="govuk-table__body">
                @{
                    List<Return> returnsForYear = Model.Organisation.Returns
                        .Where(r => r.AccountingDate.Year == Model.Year)
                        .OrderByDescending(r => r.StatusDate)
                        .ToList();
                }

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Revision number</th>
                    @for (int version = returnsForYear.Count; version > 0; version--)
                    {
                        <th scope="col" class="govuk-table__header">
                            version @(version)
                        </th>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">
                        <span class="govuk-visually-hidden">Date</span>
                        Modified
                    </th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            <span style="white-space: nowrap">
                                @(returnForYear.Modified.ToString("d MMM yyyy"))
                            </span>
                            <span style="white-space: nowrap">
                                @(returnForYear.Modified.ToString("HH:mm"))
                            </span>
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Status</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.Status)</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Modifications</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            @(returnForYear.Modifications != null
                                ? string.Join(", ", returnForYear.Modifications.Split(",", StringSplitOptions.RemoveEmptyEntries))
                                : "")
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Late submission</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            @(returnForYear.IsLateSubmission ? "Yes" : "No")
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Reason for late submission</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.LateReason)</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">
                        <span class="govuk-visually-hidden">Number of</span>
                        Employees
                    </th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.MinEmployees) - @(returnForYear.MaxEmployees)</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Hourly pay gap (mean)</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.DiffMeanHourlyPayPercent.ToString("0.#"))%</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Hourly pay gap (median)</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.DiffMedianHourlyPercent.ToString("0.#"))%</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Who is paid a bonus</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            <span style="white-space: nowrap;">@(returnForYear.MaleMedianBonusPayPercent.ToString("0"))% of men</span>
                            <br/>
                            <span style="white-space: nowrap;">@(returnForYear.FemaleMedianBonusPayPercent.ToString("0"))% of women</span>
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Bonus pay gap (mean)</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.DiffMeanBonusPercent?.ToString("0.##"))%</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Bonus pay gap (median)</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">@(returnForYear.DiffMedianBonusPercent?.ToString("0.##"))%</td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Highest paid quarter</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            <span style="white-space: nowrap;">@(returnForYear.MaleUpperQuartilePayBand.ToString("0"))% male</span>
                            <br/>
                            <span style="white-space: nowrap;">@(returnForYear.FemaleUpperQuartilePayBand.ToString("0"))% female</span>
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">2nd-highest paid quarter</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            <span style="white-space: nowrap;">@(returnForYear.MaleUpperPayBand.ToString("0"))% male</span>
                            <br/>
                            <span style="white-space: nowrap;">@(returnForYear.FemaleUpperPayBand.ToString("0"))% female</span>
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">2nd-lowest paid quarter</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            <span style="white-space: nowrap;">@(returnForYear.MaleMiddlePayBand.ToString("0"))% male</span>
                            <br/>
                            <span style="white-space: nowrap;">@(returnForYear.FemaleMiddlePayBand.ToString("0"))% female</span>
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Lowest paid quarter</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            <span style="white-space: nowrap;">@(returnForYear.MaleLowerPayBand.ToString("0"))% male</span>
                            <br/>
                            <span style="white-space: nowrap;">@(returnForYear.FemaleLowerPayBand.ToString("0"))% female</span>
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Link to company website</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            @if (!string.IsNullOrWhiteSpace(returnForYear.CompanyLinkToGPGInfo))
                            {
                                try
                                {
                                    <a href="@(returnForYear.CompanyLinkToGPGInfo)"
                                       class="govuk-link">
                                        Link
                                    </a>
                                }
                                catch
                                {
                                    @(returnForYear.CompanyLinkToGPGInfo)
                                }
                            }
                            else
                            {
                                @:No link
                            }
                        </td>
                    }
                </tr>

                <tr class="govuk-table__row">
                    <th scope="row" class="govuk-table__header">Senior Responsible Officer</th>
                    @foreach (Return returnForYear in returnsForYear)
                    {
                        <td class="govuk-table__cell">
                            @(returnForYear.FirstName) @(returnForYear.LastName)
                            <br />
                            (@(returnForYear.JobTitle))
                        </td>
                    }
                </tr>
            </tbody>
        </table>


    </div>
</div>
