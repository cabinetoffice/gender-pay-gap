{"version":3,"sources":["../../../src/panels/call-to-action/module.js"],"names":["dark","light","CallToActionCtrl","$scope","$injector","$location","$q","backendSrv","alertSrv","contextSrv","datasourceSrv","quotas","endpointStatus","collectorStatus","requiresUpgrade","currentlyTrial","aboveFreeTier","getOrgDetails","datasourceUpgrader","DatasourceUpgrader","endpoint","used","probe","self","p","get","then","resp","org","millionChecksPerMonth","Math","ceil","parseInt","checksPerMonth","strChecksPerMonth","_requiresUpgrade","_currentlyTrial","_aboveFreeTier","set","statusText","wpPlan","meta","code","message","reject","quotaHash","_","forEach","body","q","target","setEndpointStatus","setCollectorStatus","PanelCtrl","templateUrl"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport {PanelCtrl} from 'app/plugins/sdk';\nimport {loadPluginCss} from 'app/plugins/sdk';\nimport DatasourceUpgrader from '../../components/config/dsUpgrade';\nimport { promiseToDigest } from '../../utils/promiseToDigest';\n\nloadPluginCss({\n  dark: 'plugins/raintank-worldping-app/css/worldping.dark.css',\n  light: 'plugins/raintank-worldping-app/css/worldping.light.css'\n});\n\nclass CallToActionCtrl extends PanelCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, $location, $q, backendSrv, alertSrv, contextSrv, datasourceSrv) {\n    super($scope, $injector);\n    this.backendSrv = backendSrv;\n    this.alertSrv = alertSrv;\n    this.$location = $location;\n    this.$q = $q;\n    this.datasourceSrv = datasourceSrv;\n\n    this.quotas = null;\n    this.endpointStatus = \"scopeEndpoints\";\n    this.collectorStatus = \"scopeCollectors\";\n    this.requiresUpgrade = null;\n    this.currentlyTrial = null;\n    this.aboveFreeTier = null;\n\n    this.getOrgDetails();\n    this.datasourceUpgrader = new DatasourceUpgrader(contextSrv, backendSrv, $q, datasourceSrv);\n  }\n\n  setEndpointStatus() {\n    if (! this.quotas) {\n      return;\n    }\n    if (this.quotas.endpoint.used === 0) {\n      this.endpointStatus = \"noEndpoints\";\n      return;\n    }\n    if (this.quotas.endpoint.used >= 1) {\n      this.endpointStatus = \"hasEndpoints\";\n      return;\n    }\n    //default.\n    this.endpointStatus = \"hasEndpoints\";\n    return;\n  }\n\n  setCollectorStatus() {\n    if (! this.quotas) {\n      return;\n    }\n    if (this.quotas.probe.used === 0) {\n      this.collectorStatus = \"noCollectors\";\n      return;\n    }\n    if (this.quotas.probe.used >= 1) {\n      this.collectorStatus = \"hasCollectors\";\n      return;\n    }\n    //default.\n    this.collectorStatus = \"hasCollectors\";\n    return;\n  }\n\n  getOrgDetails() {\n    var self = this;\n    var p = promiseToDigest(this.$scope)(this.backendSrv.get('api/plugin-proxy/raintank-worldping-app/api/grafana-net/profile/org'));\n    p.then((resp) => {\n      self.org = resp;\n\n      const millionChecksPerMonth = Math.ceil(parseInt(self.org.checksPerMonth, 10) / 100000) / 10;\n      if (millionChecksPerMonth > 1000) {\n        self.org.strChecksPerMonth = 'using ' + Math.ceil(millionChecksPerMonth / 1000) + ' Billion checks/mo';\n      } else if (millionChecksPerMonth > 0) {\n        self.org.strChecksPerMonth = 'using ' + millionChecksPerMonth + ' Million checks/mo';\n      } else {\n        self.org.strChecksPerMonth = 'not using any checks yet';\n      }\n\n      self.requiresUpgrade = self._requiresUpgrade();\n      self.currentlyTrial = self._currentlyTrial();\n      self.aboveFreeTier = self._aboveFreeTier();\n    }, (resp) => {\n      self.alertSrv.set(\"failed to get Org Details\", resp.statusText, 'error', 10000);\n    });\n    return p;\n  }\n\n  _currentlyTrial() {\n    if (!this.org) {\n      return false;\n    }\n\n    if (this.org.wpPlan === 'trial') {\n      return true;\n    }\n\n    return false;\n  }\n\n  _requiresUpgrade() {\n    if (!this.org) {\n      return true;\n    }\n\n    if (this.org.wpPlan !== '' && this.org.wpPlan !== 'free' && this.org.wpPlan !== 'trial') {\n      return false;\n    }\n\n    return true;\n  }\n\n  _aboveFreeTier() {\n    if (!this.org) {\n      return false;\n    }\n\n    if (this.org.wpPlan !== '' && this.org.wpPlan !== 'free') {\n      return false;\n    }\n\n    if (this.org.checksPerMonth / 1000000 > 1) {\n      return true;\n    }\n\n    return false;\n  }\n\n  allDone() {\n    if (! this.quotas) {\n      return false;\n    }\n    if (this.quotas.probe.used === 0) {\n      return false;\n    }\n    if (this.quotas.endpoint.used === 0) {\n      return false;\n    }\n    //default.\n    return true;\n  }\n\n  refresh() {\n    var self = this;\n    return promiseToDigest(this.$scope)(this.backendSrv.get('api/plugin-proxy/raintank-worldping-app/api/v2/quotas').then(function(resp) {\n      if (resp.meta.code !== 200) {\n        self.alertSrv.set(\"failed to get quotas.\", resp.meta.message, 'error', 10000);\n        return self.$q.reject(resp.meta.message);\n      }\n      var quotaHash = {};\n      _.forEach(resp.body, function(q) {\n        quotaHash[q.target] = q;\n      });\n      self.quotas = quotaHash;\n      self.setEndpointStatus();\n      self.setCollectorStatus();\n    }));\n  }\n}\n\nCallToActionCtrl.templateUrl = 'public/plugins/raintank-worldping-app/panels/call-to-action/module.html';\n\nexport {\n  CallToActionCtrl as PanelCtrl\n};\n"],"file":"module.js"}